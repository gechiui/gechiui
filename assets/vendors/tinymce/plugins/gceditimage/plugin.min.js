tinymce.PluginManager.add("gceditimage",function(p){var c,u,n,r,a,e=tinymce.each,l=tinymce.trim,t=tinymce.Env.iOS;function i(e){return!(!p.dom.getAttrib(e,"data-mce-placeholder")&&!p.dom.getAttrib(e,"data-mce-object"))}function o(e){e=p.$(e).parents("[contenteditable]");return e&&"false"===e.attr("contenteditable")}function d(e){return e.replace(/(?:<p>)?\[(?:gc_)?caption([^\]]+)\]([\s\S]+?)\[\/(?:gc_)?caption\](?:<\/p>)?/g,function(e,t,n){var a,i,o,c,r,d=t.match(/id=['"]([^'"]*)['"] ?/);return(r=(t=(i=(t=(a=(t=d?t.replace(d[0],""):t).match(/align=['"]([^'"]*)['"] ?/))?t.replace(a[0],""):t).match(/class=['"]([^'"]*)['"] ?/))?t.replace(i[0],""):t).match(/width=['"]([0-9]*)['"] ?/))&&(t=t.replace(r[0],"")),c=(c=(n=l(n)).match(/((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)([\s\S]*)/i))&&c[2]?(o=l(c[2]),l(c[1])):(o=l(t).replace(/caption=['"]/,"").replace(/['"]$/,""),n),d=d&&d[1]?d[1].replace(/[<>&]+/g,""):"",a=a&&a[1]?a[1]:"alignnone",i=i&&i[1]?" "+i[1].replace(/[<>&]+/g,""):"",(r=(r=!r&&c?c.match(/width=['"]([0-9]*)['"]/):r)&&r[1]?r[1]:r)&&o?(r=parseInt(r,10),p.getParam("gceditimage_html5_captions")||(r+=10),'<div class="mceTemp"><dl id="'+d+'" class="gc-caption '+a+i+'" style="width: '+r+'px"><dt class="gc-caption-dt">'+c+'</dt><dd class="gc-caption-dd">'+o+"</dd></dl></div>"):n})}function s(e){return e.replace(/(?:<div [^>]+mceTemp[^>]+>)?\s*(<dl [^>]+gc-caption[^>]+>[\s\S]+?<\/dl>)\s*(?:<\/div>)?/g,function(e,t){var n="";return-1===t.indexOf("<img ")||-1!==t.indexOf("</p>")?t.replace(/<d[ldt]( [^>]+)?>/g,"").replace(/<\/d[ldt]>/g,""):-1===(n=t.replace(/\s*<dl ([^>]+)>\s*<dt [^>]+>([\s\S]+?)<\/dt>\s*<dd [^>]+>([\s\S]*?)<\/dd>\s*<\/dl>\s*/gi,function(e,t,n,a){var i,o,c=n.match(/width="([0-9]*)"/);return c=c&&c[1]?c[1]:"",o=(i=(i=t.match(/class="([^"]*)"/))&&i[1]?i[1]:"").match(/align[a-z]+/i)||"alignnone",c&&a?'[caption id="'+(t=(t=t.match(/id="([^"]*)"/))&&t[1]?t[1]:"")+'" align="'+o+'" width="'+c+'"'+(i=(i=i.replace(/gc-caption ?|align[a-z]+ ?/gi,""))&&' class="'+i+'"')+"]"+n+" "+(a=(a=a.replace(/\r\n|\r/g,"\n").replace(/<[a-zA-Z0-9]+( [^<>]+)?>/g,function(e){return e.replace(/[\r\n\t]+/," ")})).replace(/\s*\n\s*/g,"<br />"))+"[/caption]":"alignnone"!==o[0]?n.replace(/><img/,' class="'+o[0]+'"><img'):n})).indexOf("[caption")?t.replace(/[\s\S]*?((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)(<p>[\s\S]*<\/p>)?[\s\S]*/gi,"<p>$1</p>$2"):n})}function h(e){return e&&(e.textContent||e.innerText).replace(/\ufeff/g,"")}function g(e){var t=p.dom.getParent(e,"div.mceTemp");(t=t||"IMG"!==e.nodeName?t:p.dom.getParent(e,"a"))?(t.nextSibling?p.selection.select(t.nextSibling):t.previousSibling?p.selection.select(t.previousSibling):p.selection.select(t.parentNode),p.selection.collapse(!0),p.dom.remove(t)):p.dom.remove(e),p.nodeChanged(),p.undoManager.add()}return p.addButton("gc_img_remove",{tooltip:"Remove",icon:"dashicon dashicons-no",onclick:function(){g(p.selection.getNode())}}),p.addButton("gc_img_edit",{tooltip:"Edit|button",icon:"dashicon dashicons-edit",onclick:function(){var e,t,n,m;e=p.selection.getNode(),"undefined"!=typeof gc&&gc.media?(n=function(e){var t,n,a,i,o=[],c=p.dom,r=/^\d+$/;(n={attachment_id:!1,size:"custom",caption:"",align:"none",extraClasses:"",link:!1,linkUrl:"",linkClassName:"",linkTargetBlank:!1,linkRel:"",title:""}).url=c.getAttrib(e,"src"),n.alt=c.getAttrib(e,"alt"),n.title=c.getAttrib(e,"title"),a=c.getAttrib(e,"width"),i=c.getAttrib(e,"height"),(!r.test(a)||parseInt(a,10)<1)&&(a=e.naturalWidth||e.width);(!r.test(i)||parseInt(i,10)<1)&&(i=e.naturalHeight||e.height);n.customWidth=n.width=a,n.customHeight=n.height=i,r=tinymce.explode(e.className," "),t=[],tinymce.each(r,function(e){/^gc-image/.test(e)?n.attachment_id=parseInt(e.replace("gc-image-",""),10):/^align/.test(e)?n.align=e.replace("align",""):/^size/.test(e)?n.size=e.replace("size-",""):t.push(e)}),n.extraClasses=t.join(" "),(a=c.getParents(e,".gc-caption")).length&&(a=a[0],r=a.className.split(" "),tinymce.each(r,function(e){/^align/.test(e)?n.align=e.replace("align",""):e&&"gc-caption"!==e&&o.push(e)}),n.captionClassName=o.join(" "),(i=c.select("dd.gc-caption-dd",a)).length&&(i=i[0],n.caption=p.serializer.serialize(i).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,"")));e.parentNode&&"A"===e.parentNode.nodeName&&(r=e.parentNode,n.linkUrl=c.getAttrib(r,"href"),n.linkTargetBlank="_blank"===c.getAttrib(r,"target"),n.linkRel=c.getAttrib(r,"rel"),n.linkClassName=r.className);return n}(e),p.$(e).attr("data-gc-editing",1),gc.media.events.trigger("editor:image-edit",{editor:p,metadata:n,image:e}),t=gc.media({frame:"image",state:"image-details",metadata:n}),gc.media.events.trigger("editor:frame-create",{frame:t}),e=function(g){p.undoManager.transact(function(){var e,t,n,a,i,o,c,r,d,l,s;e=m,t=g,s=p.dom,e&&e.length&&(a=e[0],c=(c=tinymce.explode(t.extraClasses," "))||[],t.caption||c.push("align"+t.align),t.attachment_id&&(c.push("gc-image-"+t.attachment_id),t.size&&"custom"!==t.size&&c.push("size-"+t.size)),l=t.width,r=t.height,"custom"===t.size&&(l=t.customWidth,r=t.customHeight),r={src:t.url,width:l||null,height:r||null,title:t.title||null,class:c.join(" ")||null},s.setAttribs(a,r),e.attr("alt",t.alt||""),c={href:t.linkUrl,rel:t.linkRel||null,target:t.linkTargetBlank?"_blank":null,class:t.linkClassName||null},a.parentNode&&"A"===a.parentNode.nodeName&&!h(a.parentNode)?t.linkUrl?s.setAttribs(a.parentNode,c):s.remove(a.parentNode,!0):t.linkUrl&&((r=s.getParent(a,"a"))&&s.insertAfter(a,r),r=s.create("a",c),a.parentNode.insertBefore(r,a),r.appendChild(a)),c=p.dom.getParent(a,".mceTemp"),r=a.parentNode&&"A"===a.parentNode.nodeName&&!h(a.parentNode)?a.parentNode:a,t.caption?(t.caption=function(e){if(!e||-1===e.indexOf("<")&&-1===e.indexOf(">"))return e;u=u||new tinymce.html.Serializer({},p.schema);return u.serialize(p.parser.parse(e,{forced_root_block:!1}))}(t.caption),o=t.attachment_id?"attachment_"+t.attachment_id:null,d="gc-caption "+(d="align"+(t.align||"none")),t.captionClassName&&(d+=" "+t.captionClassName.replace(/[<>&]+/g,"")),p.getParam("gceditimage_html5_captions")||(l=parseInt(l,10),l+=10),c?((i=s.select("dl.gc-caption",c)).length&&s.setAttribs(i,{id:o,class:d,style:"width: "+l+"px"}),(i=s.select(".gc-caption-dd",c)).length&&s.setHTML(i[0],t.caption)):(i="<dl "+(o=o?'id="'+o+'" ':"")+'class="'+d+'" style="width: '+l+'px"><dt class="gc-caption-dt"></dt><dd class="gc-caption-dd">'+t.caption+"</dd></dl>",o=s.create("div",{class:"mceTemp"},i),(n=s.getParent(r,"p"))?n.parentNode.insertBefore(o,n):r.parentNode.insertBefore(o,r),p.$(o).find("dt.gc-caption-dt").append(r),n&&s.isEmpty(n)&&s.remove(n))):c&&(n=s.create("p"),c.parentNode.insertBefore(n,c),n.appendChild(r),s.remove(c)),e=p.$(a),d=e.attr("srcset"),l=e.attr("src"),d&&l&&(l=l.replace(/[?#].*/,""),-1===d.indexOf(l)&&e.attr("srcset",null).attr("sizes",null)),gc.media.events&&gc.media.events.trigger("editor:image-update",{editor:p,metadata:t,image:a}),p.nodeChanged())}),t.detach()},t.state("image-details").on("update",e),t.state("replace-image").on("replace",e),t.on("close",function(){p.focus(),t.detach(),(m=p.$("img[data-gc-editing]")).removeAttr("data-gc-editing")}),t.open()):p.execCommand("mceImage")}}),e({alignleft:"Align left",aligncenter:"Align center",alignright:"Align right",alignnone:"No alignment"},function(e,n){var t=n.slice(5);p.addButton("gc_img_"+n,{tooltip:e,icon:"dashicon dashicons-align-"+t,cmd:"alignnone"===n?"gcAlignNone":"Justify"+t.slice(0,1).toUpperCase()+t.slice(1),onPostRender:function(){var t=this;p.on("NodeChange",function(e){"IMG"===e.element.nodeName&&(e=p.dom.getParent(e.element,".gc-caption")||e.element,"alignnone"===n?t.active(!/\balign(left|center|right)\b/.test(e.className)):t.active(p.dom.hasClass(e,n)))})}})}),p.once("preinit",function(){p.gc&&p.gc._createToolbar&&(c=p.gc._createToolbar(["gc_img_alignleft","gc_img_aligncenter","gc_img_alignright","gc_img_alignnone","gc_img_edit","gc_img_remove"]))}),p.on("gctoolbar",function(e){"IMG"!==e.element.nodeName||i(e.element)||(e.toolbar=c)}),t&&p.on("init",function(){p.on("touchstart",function(e){"IMG"!==e.target.nodeName||o(e.target)||(n=!0)}),p.dom.bind(p.getDoc(),"touchmove",function(){n=!1}),p.on("touchend",function(e){var t;n&&"IMG"===e.target.nodeName&&!o(e.target)?(t=e.target,n=!1,window.setTimeout(function(){p.selection.select(t),p.nodeChanged()},100)):c&&c.hide()})}),p.on("init",function(){var t=p.dom,e=p.getParam("gceditimage_html5_captions")?"html5-captions":"html4-captions";t.addClass(p.getBody(),e),tinymce.Env.ie&&10<tinymce.Env.ie&&t.bind(p.getBody(),"mscontrolselect",function(e){"IMG"===e.target.nodeName&&t.getParent(e.target,".gc-caption")?p.getBody().focus():"DL"===e.target.nodeName&&t.hasClass(e.target,"gc-caption")&&e.target.focus()})}),p.on("ObjectResized",function(a){var i=a.target;"IMG"===i.nodeName&&p.undoManager.transact(function(){var e,t,n=p.dom;i.className=i.className.replace(/\bsize-[^ ]+/,""),(e=n.getParent(i,".gc-caption"))&&(t=a.width||n.getAttrib(i,"width"))&&(t=parseInt(t,10),p.getParam("gceditimage_html5_captions")||(t+=10),n.setStyle(e,"width",t+"px"))})}),p.on("pastePostProcess",function(e){p.dom.getParent(p.selection.getNode(),"dd.gc-caption-dd")&&(p.$("img, audio, video, object, embed, iframe, script, style",e.node).remove(),p.$("*",e.node).each(function(e,t){p.dom.isBlock(t)&&(tinymce.trim(t.textContent||t.innerText)?(p.dom.insertAfter(p.dom.create("br"),t),p.dom.remove(t,!0)):p.dom.remove(t))}),p.$("br",e.node).each(function(e,t){t.nextSibling&&"BR"!==t.nextSibling.nodeName&&t.previousSibling&&"BR"!==t.previousSibling.nodeName||p.dom.remove(t)}),r=!0)}),p.on("BeforeExecCommand",function(e){var t,n,a,i=e.command,o=p.dom;if("mceInsertContent"===i||"Indent"===i||"Outdent"===i){if(t=p.selection.getNode(),a=o.getParent(t,"div.mceTemp")){if("mceInsertContent"!==i)return e.preventDefault(),e.stopImmediatePropagation(),!1;r?r=!1:(n=o.create("p"),o.insertAfter(n,a),p.selection.setCursorLocation(n,0),"IMG"===t.nodeName&&p.$(a).remove(),p.nodeChanged())}}else"JustifyLeft"!==i&&"JustifyRight"!==i&&"JustifyCenter"!==i&&"gcAlignNone"!==i||(t=p.selection.getNode(),o="align"+i.slice(7).toLowerCase(),n=p.dom.getParent(t,".gc-caption"),"IMG"!==t.nodeName&&!n||(a=p.dom.hasClass(t=n||t,o)?" alignnone":" "+o,t.className=l(t.className.replace(/ ?align(left|center|right|none)/g,"")+a),p.nodeChanged(),e.preventDefault(),c&&c.reposition(),p.fire("ExecCommand",{command:i,ui:e.ui,value:e.value})))}),p.on("keydown",function(e){var t,n,a,i=p.selection,o=e.keyCode,c=p.dom,r=tinymce.util.VK;if(o===r.ENTER)t=i.getNode(),(n=c.getParent(t,"div.mceTemp"))&&(c.events.cancel(e),tinymce.each(c.select("dt, dd",n),function(e){c.isEmpty(e)&&c.remove(e)}),a=tinymce.Env.ie&&tinymce.Env.ie<11?"":'<br data-mce-bogus="1" />',a=c.create("p",null,a),"DD"===t.nodeName?c.insertAfter(a,n):n.parentNode.insertBefore(a,n),p.nodeChanged(),i.setCursorLocation(a,0));else if((o===r.DELETE||o===r.BACKSPACE)&&("DIV"===(t=i.getNode()).nodeName&&c.hasClass(t,"mceTemp")?n=t:"IMG"!==t.nodeName&&"DT"!==t.nodeName&&"A"!==t.nodeName||(n=c.getParent(t,"div.mceTemp")),n))return c.events.cancel(e),g(t),!1}),tinymce.Env.gecko&&p.on("undo redo",function(){"IMG"===p.selection.getNode().nodeName&&p.selection.collapse()}),p.gcSetImgCaption=d,p.gcGetImgCaption=s,p.on("beforeGetContent",function(e){"raw"!==e.format&&p.$('img[id="__gc-temp-img-id"]').removeAttr("id")}),p.on("BeforeSetContent",function(e){"raw"!==e.format&&(e.content=p.gcSetImgCaption(e.content))}),p.on("PostProcess",function(e){e.get&&(e.content=p.gcGetImgCaption(e.content))}),p.on("dragstart",function(){var e=p.selection.getNode();"IMG"!==e.nodeName||(a=p.dom.getParent(e,".mceTemp"))||"A"!==e.parentNode.nodeName||h(e.parentNode)||(a=e.parentNode)}),p.on("drop",function(e){var t=p.dom,n=tinymce.dom.RangeUtils.getCaretRangeFromPoint(e.clientX,e.clientY,p.getDoc());n&&t.getParent(n.startContainer,".mceTemp")?e.preventDefault():a&&(e.preventDefault(),p.undoManager.transact(function(){n&&p.selection.setRng(n),p.selection.setNode(a),t.remove(a)})),a=null}),p.gc=p.gc||{},p.gc.isPlaceholder=i,{_do_shcode:d,_get_shcode:s}});